<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <script>
     function Promise(fn){
        this.state = 'pending';
        this.doneLists = [];
        this.value = null;
        var _that = this;
       
        function resolve(newValue) {
 
            // 判断传入的是否是promise
            if (newValue && (newValue instanceof Promise)) {
             
                var then = newValue.then;
                if (typeof then === 'function') {
                    then.call(newValue, resolve);
                    return;
                }
            }

            _that.state = 'fulfilled';
            _that.value = newValue;
            setTimeout(function () {
                _that.doneLists.forEach(function (deferred) {
                   _that.handle(deferred);
                });
            }, 0);
        }

        fn(resolve);
    }

    Promise.prototype.then = function(done){
        var _that = this
        return new Promise(function(resolve){
            _that.handle({
                done: done || null,
                resolve: resolve
            });
        });
    }

    Promise.prototype.handle = function(deferred){
            if (this.state  === 'pending') {
                this.doneLists.push(deferred);
                return;
            }
            var ret = deferred.done(this.value);
            deferred.resolve(ret);
    }

    // 测试
    var p = function (){
        return new Promise(function(resolve){
            setTimeout(function(){
              resolve("11111111");
            }, 1000);
        });
    }
    p()
    .then(function(res){
      console.log(res)
      return "第一次then的结果"
    }).then(function(res){
        debugger
      console.log("第二个then中拿到的第一个then的返回值："+ res)
      return new Promise(function(resolve){
        setTimeout(function(){
          resolve("第二个的then值")
        },1000)
        
      })
    }).then(function(res){
      console.log("第三个then中拿到的第二个then的值："+ res)
      return "第三个then的返回值"
    }).then(function(res){
      console.log(res)
    })
  </script>
</body>
</html>