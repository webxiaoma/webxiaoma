<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Worker API | 马新想个人网站（webxiaoma）</title>
    <meta name="description" content="本文章主要总结Service Worker API 在离线缓存中如何使用。">
    <link rel="icon" href="/img/icon.ico">
    <meta name="keywords" content="Service Worker  Service-Worker离线缓存 wpa">
    <link rel="preload" href="/assets/css/0.styles.d0698a8e.css" as="style"><link rel="preload" href="/assets/js/app.295b5d07.js" as="script"><link rel="preload" href="/assets/js/30.291321ea.js" as="script"><link rel="prefetch" href="/assets/js/36.f33b80a3.js"><link rel="prefetch" href="/assets/js/2.eea0509a.js"><link rel="prefetch" href="/assets/js/3.5f0d52d2.js"><link rel="prefetch" href="/assets/js/4.3d2adc31.js"><link rel="prefetch" href="/assets/js/5.4508aed4.js"><link rel="prefetch" href="/assets/js/6.926d9992.js"><link rel="prefetch" href="/assets/js/7.de112116.js"><link rel="prefetch" href="/assets/js/8.540857f9.js"><link rel="prefetch" href="/assets/js/9.ec3e2f68.js"><link rel="prefetch" href="/assets/js/10.2be97ddc.js"><link rel="prefetch" href="/assets/js/11.1c29fab3.js"><link rel="prefetch" href="/assets/js/12.1356d18f.js"><link rel="prefetch" href="/assets/js/13.9097994e.js"><link rel="prefetch" href="/assets/js/14.1eb5a811.js"><link rel="prefetch" href="/assets/js/15.8f38c4e5.js"><link rel="prefetch" href="/assets/js/16.3a541095.js"><link rel="prefetch" href="/assets/js/17.06469cea.js"><link rel="prefetch" href="/assets/js/18.8ce5aa90.js"><link rel="prefetch" href="/assets/js/19.6b8b1a7e.js"><link rel="prefetch" href="/assets/js/20.96de4233.js"><link rel="prefetch" href="/assets/js/21.792b2068.js"><link rel="prefetch" href="/assets/js/22.2bf90abe.js"><link rel="prefetch" href="/assets/js/23.cad0d609.js"><link rel="prefetch" href="/assets/js/24.3c08b89f.js"><link rel="prefetch" href="/assets/js/25.d34214d5.js"><link rel="prefetch" href="/assets/js/26.58ed5e8f.js"><link rel="prefetch" href="/assets/js/27.abfa00ae.js"><link rel="prefetch" href="/assets/js/28.152e7ebe.js"><link rel="prefetch" href="/assets/js/29.33c39198.js"><link rel="prefetch" href="/assets/js/31.131e09d0.js"><link rel="prefetch" href="/assets/js/32.53d85eec.js"><link rel="prefetch" href="/assets/js/33.56d129ad.js"><link rel="prefetch" href="/assets/js/34.310c8fd4.js"><link rel="prefetch" href="/assets/js/35.b11488fe.js"><link rel="prefetch" href="/assets/js/37.a2ba17e8.js"><link rel="prefetch" href="/assets/js/38.566f6e5e.js"><link rel="prefetch" href="/assets/js/39.a44cf70a.js"><link rel="prefetch" href="/assets/js/40.cada13c7.js"><link rel="prefetch" href="/assets/js/41.6c542d24.js"><link rel="prefetch" href="/assets/js/42.ccb8a96a.js"><link rel="prefetch" href="/assets/js/43.c3e8ca6a.js"><link rel="prefetch" href="/assets/js/44.8189940b.js"><link rel="prefetch" href="/assets/js/45.b8bb305d.js"><link rel="prefetch" href="/assets/js/46.6bb42f12.js"><link rel="prefetch" href="/assets/js/47.b65e9317.js"><link rel="prefetch" href="/assets/js/48.31a5c1b1.js"><link rel="prefetch" href="/assets/js/49.aa4e5876.js"><link rel="prefetch" href="/assets/js/50.6d6ef67e.js"><link rel="prefetch" href="/assets/js/51.6e625702.js"><link rel="prefetch" href="/assets/js/52.e90af6bc.js"><link rel="prefetch" href="/assets/js/53.1adfaa0a.js"><link rel="prefetch" href="/assets/js/54.24ccac71.js"><link rel="prefetch" href="/assets/js/55.58a0ad3f.js"><link rel="prefetch" href="/assets/js/56.73d081a6.js"><link rel="prefetch" href="/assets/js/57.f429bc94.js"><link rel="prefetch" href="/assets/js/58.3c566d08.js"><link rel="prefetch" href="/assets/js/59.3d68d2a8.js"><link rel="prefetch" href="/assets/js/60.f9c2a626.js"><link rel="prefetch" href="/assets/js/61.d2a25a81.js"><link rel="prefetch" href="/assets/js/62.82872ac2.js"><link rel="prefetch" href="/assets/js/63.9df744ee.js"><link rel="prefetch" href="/assets/js/64.7e215adc.js"><link rel="prefetch" href="/assets/js/65.d552d81c.js"><link rel="prefetch" href="/assets/js/66.5ea1803f.js"><link rel="prefetch" href="/assets/js/67.2e871669.js"><link rel="prefetch" href="/assets/js/68.bcae3fc6.js"><link rel="prefetch" href="/assets/js/69.c7959212.js"><link rel="prefetch" href="/assets/js/70.fc8ecce7.js"><link rel="prefetch" href="/assets/js/71.e99d0c10.js"><link rel="prefetch" href="/assets/js/72.8e48aaf4.js"><link rel="prefetch" href="/assets/js/73.99ba7860.js"><link rel="prefetch" href="/assets/js/74.229b8b6d.js"><link rel="prefetch" href="/assets/js/75.b68afb81.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d0698a8e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/manong.jpg" alt="马新想" class="logo"> <span class="site-name can-hide">马新想个人网站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide" data-v-2b50ec5c><ul role="menubar" class="el-menu-demo el-menu--horizontal el-menu" style="background-color:;" data-v-2b50ec5c><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        首页
        <!----></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
        前端
      <i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        JavaScript
         <!----></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
          移动端
        <i class="el-submenu__icon-arrow el-icon-arrow-right"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          H5页面开发
           <!----></li></ul></div></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
          构建工具
        <i class="el-submenu__icon-arrow el-icon-arrow-right"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          Webpack打包
           <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          Git工具
           <!----></li></ul></div></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        Vue
         <!----></li></ul></div></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
        后端
      <i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        Linux
         <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        NodeJS
         <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        网络知识
         <!----></li></ul></div></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        English
        <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        
        <a href="https://github.com/webxiaoma" target="_blank" style="padding-bottom:5px;" data-v-2b50ec5c>GitHub</a></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        
        <a href="https://github.com/webxiaoma/webxiaoma/issues" target="_blank" style="padding-bottom:5px;" data-v-2b50ec5c>提出疑问</a></li></ul></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar" data-v-5534fc3a><nav class="nav-links" data-v-2b50ec5c data-v-5534fc3a><ul role="menubar" class="el-menu-demo el-menu--horizontal el-menu" style="background-color:;" data-v-2b50ec5c><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        首页
        <!----></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
        前端
      <i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        JavaScript
         <!----></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
          移动端
        <i class="el-submenu__icon-arrow el-icon-arrow-right"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          H5页面开发
           <!----></li></ul></div></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
          构建工具
        <i class="el-submenu__icon-arrow el-icon-arrow-right"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          Webpack打包
           <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
          Git工具
           <!----></li></ul></div></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        Vue
         <!----></li></ul></div></li><li role="menuitem" aria-haspopup="true" class="el-submenu" data-v-2b50ec5c><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">
        后端
      <i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        Linux
         <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        NodeJS
         <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;" data-v-2b50ec5c>
        网络知识
         <!----></li></ul></div></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        English
        <!----></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        
        <a href="https://github.com/webxiaoma" target="_blank" style="padding-bottom:5px;" data-v-2b50ec5c>GitHub</a></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;" data-v-2b50ec5c>
        
        <a href="https://github.com/webxiaoma/webxiaoma/issues" target="_blank" style="padding-bottom:5px;" data-v-2b50ec5c>提出疑问</a></li></ul></nav>  <ul class="sidebar-links" data-v-5534fc3a><li data-v-5534fc3a><a href="/javascript/" class="sidebar-link" data-v-5534fc3a>网站</a></li><li data-v-5534fc3a><div class="sidebar-group collapsable" data-v-5534fc3a><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></div></li><li data-v-5534fc3a><div class="sidebar-group collapsable" data-v-5534fc3a><p class="sidebar-heading"><span>ES6篇</span> <span class="arrow right"></span></p> <!----></div></li><li data-v-5534fc3a><div class="sidebar-group collapsable" data-v-5534fc3a><p class="sidebar-heading"><span>音频视频处理</span> <span class="arrow right"></span></p> <!----></div></li><li data-v-5534fc3a><div class="sidebar-group collapsable" data-v-5534fc3a><p class="sidebar-heading"><span>文件与二进制处理</span> <span class="arrow right"></span></p> <!----></div></li><li data-v-5534fc3a><div class="sidebar-group collapsable" data-v-5534fc3a><p class="sidebar-heading open"><span>离线与缓存</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/javascript/cache-api.html" class="sidebar-link">缓存对象Cache API</a></li><li><a href="/javascript/web-worker.html" class="sidebar-link">多线程 Web Worker</a></li><li><a href="/javascript/service-worker.html" class="active sidebar-link">Service Worker API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#github-仓库" class="sidebar-link">GitHub 仓库</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#事件类型" class="sidebar-link">事件类型</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#使用方法" class="sidebar-link">使用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#注册-service-worker" class="sidebar-link">注册 Service Worker</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#代理请求" class="sidebar-link">代理请求</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#更新" class="sidebar-link">更新</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#传递信息" class="sidebar-link">传递信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#主进程向service-worker通信" class="sidebar-link">主进程向Service Worker通信</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#service-worker向主进程通信" class="sidebar-link">Service Worker向主进程通信</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#使用-messagechannel-通信" class="sidebar-link">使用 MessageChannel 通信</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#开发调试" class="sidebar-link">开发调试</a></li><li class="sidebar-sub-header"><a href="/javascript/service-worker.html#实例" class="sidebar-link">实例</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="service-worker-api"><a href="#service-worker-api" aria-hidden="true" class="header-anchor">#</a> Service Worker API</h1> <h2 id="github-仓库"><a href="#github-仓库" aria-hidden="true" class="header-anchor">#</a> <a href="https://github.com/webxiaoma/JavaScript-demos/tree/master/web-api/service-worker" target="_blank" rel="noopener noreferrer">GitHub 仓库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <h2 id="简介"><a href="#简介" aria-hidden="true" class="header-anchor">#</a> 简介</h2> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener noreferrer">Service Worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是W3C组织提出的主要用来做持久的离线缓存。它脱离了<code>javascript</code>的主线程，在另一个线程上进行运行的，和<code>javascript</code>的主线程互不干扰，因为js运行在单线程上，所以使用<code>Service Worker</code>可以避免js一直等待耗资源、耗时间的复杂运算。这些耗资源、耗时间的复杂运算可以放到其他线程去操作，并且还可以将一些静态资源缓存起来。</p> <p><strong><code>Service Worker</code> 有以下功能和特性：</strong></p> <ul><li>一个独立的<code>worker</code>线程，独立于当前网页进程，有自己独立的<code>worker context</code>。</li> <li>一旦被<code>install</code>，就永远存在，除非被手动 <code>unregister</code></li> <li>用到的时候可以直接唤醒，不用的时候自动睡眠</li> <li>可编程拦截代理请求和返回，缓存文件，缓存的文件可以被网页进程取到（包括网络离线状态）</li> <li>离线内容开发者可控</li> <li>能向客户端推送消息</li> <li>不能直接操作<code>DOM</code>，没有<code>window</code>,但是可以使用<code>self</code>或<code>this</code></li> <li>必须在 <code>HTTPS</code>环境下才能工作（在本地测试时可以使用<code>localhost</code>和 <code>http://127.0.0.0</code>)</li> <li>异步实现，内部大都是通过 <code>Promise</code> 实现</li></ul> <p>关于浏览器的兼容性可以<a href="https://caniuse.com/#feat=serviceworkers" target="_blank" rel="noopener noreferrer">查看这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="生命周期"><a href="#生命周期" aria-hidden="true" class="header-anchor">#</a> 生命周期</h2> <p><code>Service Worker</code> 的生命周期如下：</p> <p><img src="/img/sw-lifecycle.png" alt="生命周期"></p> <p><strong>1. <code>installing</code>安装：</strong> 这个状态发生在<code>Service Worker</code>注册之后，表示开始安装，触发 <code>install</code> 事件回调指定一些静态资源进行离线缓存。
<code>install</code> 事件回调中有两个方法：</p> <ul><li><code>event.waitUntil()</code>：传入一个 <code>Promise</code> 为参数，等到该 <code>Promise</code> 为 <code>resolve</code> 状态为止。</li> <li><code>self.skipWaiting()</code>：<code>self</code> 是当前 <code>context</code> 的 <code>global</code> 变量，执行该方法表示强制当前处在 <code>waiting</code> 状态的 <code>Service Worker</code>进入 <code>activate</code> 状态。</li></ul> <p><strong>2. <code>installed</code>安装后：</strong> <code>Service Worker</code> 已经完成了安装，并且等待其他的 <code>Service Worker</code> 线程被关闭。</p> <p><strong>3. <code>activating</code> 激活：</strong> 这个状态下没有被其他的 <code>Service Worker</code> 控制的客户端，允许当前的 <code>worker</code> 完成安装，并且清除了其他的 <code>worker</code> 以及关联缓存的旧缓存资源，等待新的 <code>Service Worker</code> 线程被激活。<code>activate</code> 回调中有两个方法：</p> <ul><li><code>event.waitUntil()</code>：传入一个 <code>Promise</code> 为参数，等到该 <code>Promise</code> 为 <code>resolve</code> 状态为止。</li> <li><code>self.clients.claim()</code>：在 <code>activate</code> 事件回调中执行该方法表示取得页面的控制权, 这样之后打开页面都会使用版本更新的缓存。旧的 <code>Service Worker</code> 脚本不再控制着页面，之后会被停止。</li></ul> <p><strong>4. <code>activated</code> 激活后：</strong> 在这个状态会处理 <code>activate</code> 事件回调 (提供了更新缓存策略的机会)。并可以处理功能性的事件 <code>fetch</code> (请求)、<code>sync</code> (后台同步)、<code>push</code> (推送)。</p> <p><strong>5. <code>redundant</code> 废弃状态：</strong> 这个状态表示一个 <code>Service Worker</code> 的生命周期结束。进入废弃 (<code>redundant</code>) 状态的原因可能为这几种：</p> <ul><li>安装 (<code>install</code>) 失败</li> <li>激活 (<code>activating</code>) 失败</li> <li>新版本的 <code>Service Worker</code> 替换了它并成为激活状态</li></ul> <h2 id="事件类型"><a href="#事件类型" aria-hidden="true" class="header-anchor">#</a> 事件类型</h2> <p><img src="/img/sw-events.png" alt="Service Worker 的事件"></p> <ul><li><strong><code>install</code>：</strong> <code>Service Worker</code> 安装成功后被触发的事件，在事件处理函数中可以添加需要缓存的文件</li> <li><strong><code>activate</code>：</strong>  当 <code>Service Worker</code> 安装完成后并进入激活状态，会触发 <code>activate</code> 事件。通过监听 <code>activate</code> 事件你可以做一些预处理，如对旧版本的更新、对无用缓存的清理等。</li> <li><strong><code>message</code>：</strong> <code>Service Worker</code> 运行于独立 <code>context</code> 中，无法直接访问当前页面主线程的 <code>DOM</code> 等信息，但是通过 <code>postMessage API</code>，可以实现他们之间的消息传递，这样主线程就可以接受 <code>Service Worker</code> 的指令操作 <code>DOM</code>。</li></ul> <p><code>Service Worker</code> 有几个重要的功能性的的事件，这些功能性的事件支撑和实现了 <code>Service Worker</code> 的特性。</p> <ul><li><strong><code>fetch</code> (请求)：</strong> 当浏览器在当前指定的 <code>scope</code> 下发起请求时，会触发 <code>fetch</code> 事件，并得到传有 <code>response</code> 参数的回调函数，回调中就可以做各种代理缓存的事情了。</li> <li><strong><code>push</code> (推送)：</strong> <code>push</code> 事件是为推送准备的。不过首先需要了解一下 <code>Notification API</code> 和 <code>PUSH API</code>。通过 <code>PUSH API</code>，当订阅了推送服务后，可以使用推送方式唤醒 <code>Service Worker</code> 以响应来自系统消息传递服务的消息，即使用户已经关闭了页面。</li> <li><strong><code>sync</code>(后台同步)：</strong> <code>sync</code> 事件由 <code>background sync</code> (后台同步)发出。<code>background sync</code> 配合 <code>Service Worker</code> 推出的 <code>API</code>，用于为 <code>Service Worker</code> 提供一个可以实现注册和监听同步处理的方法。但它还不在 <code>W3C Web API</code> 标准中。在 <code>Chrome</code> 中这也只是一个实验性功能，需要访问 <code>chrome://flags/#enable-experimental-web-platform-features</code>，开启该功能，然后重启生效。</li></ul> <h2 id="使用方法"><a href="#使用方法" aria-hidden="true" class="header-anchor">#</a> 使用方法</h2> <h3 id="注册-service-worker"><a href="#注册-service-worker" aria-hidden="true" class="header-anchor">#</a> 注册 Service Worker</h3> <p>了解了<code>Service Worker</code>的生命周期和事件类型，我们使用<code>Service Worker</code>也是很简单。
第一步我们需要在js主线程中注册<code>Service Worker</code>, 这个主线程可以是任意一个<code>js</code>文件，比如这里我们是<code>main.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 判断浏览器是否支持serviceWorker</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听页面onload事件，等页面加载完成后注册serviceWorker</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册serviceWorker</span>
        <span class="token comment">// 调用register方法时，浏览器会判断Service Worker 线程是否已注册并做出相应的处理。</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>scope<span class="token punctuation">:</span> <span class="token string">'./'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>registration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 注册成功</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ServiceWorker 注册成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 注册失败:(</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册失败: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要注意的是<code>register</code>方法中的<code>scope</code>属性是设置<code>Service Worker</code>的作用域目录的，设置该作用域目录后，<code>Service Worker</code> 线程只能捕获到该域下的页面中的<code>fetch</code>事件。</p> <p>判断石佛注册成功我们可以查看这里：</p> <p><img src="/img/service-worker1.jpg" alt="注册service worker"></p> <h3 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h3> <p>我们将<code>service-worker.js</code>文件注册为<code>Service Worker</code>后，浏览器就中就有了也给<code>worker context</code>了，这时，浏览器会安装并激活它，此时会触发<code>intall</code>事件，我们可以监听<code>install</code>事件，并在该事件下使用<a href="/javascript/cache-api.html">Cache API</a>缓存我们的静态资源。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//service-worker.js</span>

<span class="token comment">// 监听 service worker 的 install 事件</span>
 self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果监听到了 service worker 已经安装成功的话，就会调用 event.waitUntil 回调函数</span>
      event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
          <span class="token comment">// 安装成功后 ServiceWorker 状 态会从 installing 变为 installed</span>
          <span class="token comment">// 安装成功后操作 CacheStorage 缓存，使用之前需要先通过 caches.open() 打开对应缓存空间。</span>
          caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'v1.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 通过 cache 缓存对象的 addAll 方法添加 precache 缓存</span>
              <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string">'./index.html'</span><span class="token punctuation">,</span>
                <span class="token string">'./main.css'</span><span class="token punctuation">,</span>
                <span class="token string">'./main.js'</span><span class="token punctuation">,</span>
                <span class="token string">'./img/manong.jpg'</span><span class="token punctuation">,</span>
              <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以通过下面方法，来查看缓存的资源列表：</p> <p><img src="/img/service-worker2.jpg" alt="安装service worker"></p> <h3 id="代理请求"><a href="#代理请求" aria-hidden="true" class="header-anchor">#</a> 代理请求</h3> <p>我们的<code>Service Worker</code>已经建立起来了，并且我们也缓存了我们的静态资源，那么我们如何使用这写缓存的静态资源呢，这里就用到了<code>fetch</code>事件，我们可以监听<code>fetch</code>事件，当目录域内有交互请求时都会触发<code>Service Worker</code>的<code>fetch</code>事件，这时我们就可以做一些处理，是继续进行交互请求资源，还是拦截，使用缓存的资源。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//service-worker.js</span>

 <span class="token comment">// 捕获请求并返回缓存数据</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// respondWith 方法可以劫持我们的请求</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理一些请求，代理的事情</span>
            <span class="token comment">// 如果 Service Worker 有自己的返回，就直接返回，减少一次 http 请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果 service worker 没有返回，那就得直接请求真实远程服务</span>
            <span class="token keyword">let</span> request <span class="token operator">=</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把原始请求拷过来</span>
            <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>httpRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// http请求的返回已被抓到，可以处置了。</span>

                <span class="token comment">// 请求失败了，直接返回失败的结果就好了。。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>httpRes <span class="token operator">||</span> httpRes<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> httpRes<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 请求成功的话，将请求缓存起来。</span>
                <span class="token keyword">var</span> responseClone <span class="token operator">=</span> httpRes<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'v1.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> responseClone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> httpRes<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以通过下面，看出请求的资源是否来自<code>server worker</code>:</p> <p><img src="/img/service-worker3.jpg" alt="安装service worker"></p> <h3 id="更新"><a href="#更新" aria-hidden="true" class="header-anchor">#</a> 更新</h3> <p>当我们的文件更新了怎么办呢，不用担心，首先对于<code>service-worker.js</code>的更新，<code>Service Worker</code>会逐字节对比，发现不同时会启动更新算法，然后会安装最新的<code>service-worker.js</code>并触发<code>install</code>事件, 此时旧的<code>Service Worker</code>还真正使用，处于激活状态，新的<code>Service Worker</code>会进入<code>waiting</code>状态直到页面tab被全部关闭，新的<code>Service Worker</code>才会生效，另外<code>Service Worker</code> 在24小时内会自动更新一次。</p> <p>另外我们也可以通过关闭页面tab，而是刷新浏览器使我们跟新的资源生效。我们需要做的就是：</p> <ul><li>在<code>Service Worker</code>进入安装阶段时，使用<code>self.skipWaiting()</code> 跳过<code>waiting</code>状态直接进入激活（activate)状态</li> <li>监听<code>activate</code>事件，在<code>activate</code>事件中执行<code>self.clients.claim()</code>来触发更新客户端上的<code>Service Worker</code>，并清理旧的<code>Service Worker</code></li> <li>修改<code>Service Worker</code>的版本</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 版本号，每当更新时，我们需要修改版本号，来更新，</span>
<span class="token comment">// 当然你也可以使用随机生成的哈希值。</span>
<span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token string">'v1.0.0'</span><span class="token punctuation">;</span> 
  <span class="token comment">// 安装阶段跳过等待，直接进入 active</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token comment">// 更新客户端</span>
            self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 清理旧版本</span>
            caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>cacheList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
                    cacheList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheName <span class="token operator">!==</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>另外因为浏览器可能会缓存<code>service-worker.js</code>文件，我们需要刷新浏览器，才会看到效果，当然你也可以将<code>service-worker.js</code>文件配置<code>cache-control: no-cache</code>来禁止浏览器缓存该文件。</p> <h2 id="传递信息"><a href="#传递信息" aria-hidden="true" class="header-anchor">#</a> 传递信息</h2> <p>有时候我们需要<code>Service Worker</code>进程和<code>js</code>的主进程进行通信，或者是其他两种进程之间通信。我们可以这样做</p> <h3 id="主进程向service-worker通信"><a href="#主进程向service-worker通信" aria-hidden="true" class="header-anchor">#</a> 主进程向Service Worker通信</h3> <p>主进程向<code>Service Worker</code>通信我们可以在js主进程中通过<code>navigator.serviceWorker.controller.postMessage()</code>方法进行, 并在<code>Service Worker</code>进程中通过监听<code>message</code>事件来获取。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js 主进程</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token punctuation">:</span> <span class="token string">'./'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller <span class="token operator">&amp;&amp;</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;来自主进程消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// service-worker.js service-worker 进程</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收主进程消息</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p> <p>注册<code>service worker</code>后 <code>registration.active</code> 对象中也有<code>postMessage()</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token punctuation">:</span> <span class="token string">'./'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>registration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     registration<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="service-worker向主进程通信"><a href="#service-worker向主进程通信" aria-hidden="true" class="header-anchor">#</a> Service Worker向主进程通信</h3> <p>从<code>Service Worker</code>进程向js主进程发送信息，我们可以这样做</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// service-worker.js </span>

self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>client <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">//service-worker 进程发送消息</span>
  client<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'service-worker 进程发来的消息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>

navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收到的消息</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
。
</code></pre></div><h3 id="使用-messagechannel-通信"><a href="#使用-messagechannel-通信" aria-hidden="true" class="header-anchor">#</a> 使用 MessageChannel 通信</h3> <p>除了上面两种通信方法外，我们还可以是要用<code>MessageChannel API</code>来实现通信。它允许我们创建一个新的信道并通过信道的两个 <code>MessagePort</code> 属性来传递数据。也就是<code>MessageChannel</code>创建了一个信息通道，而这个通道有两个通信路径<code>port1</code>和<code>port2</code>,每个路径都可以通过<code>postMessage</code>来发送数据，通过<code>onmessage</code> 回调接收数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> messageChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>scope<span class="token punctuation">:</span> <span class="token string">'./'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>registration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 messageChannel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//接收来自port2的信息</span>
                 <span class="token punctuation">}</span>
                 <span class="token comment">// 将messageChannel 的 第二个通道port2通道端口传给 service worker 进程</span>
                 registration<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'来自主线程的消息'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>messageChannel<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ServiceWorker 注册成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 注册失败:(</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册失败: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// service-worker.js </span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span>event<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// 来自主线程的消息</span>
    <span class="token comment">//event.ports[0] 就是port2 通道端口</span>
    event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'来自service worker 的消息'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="开发调试"><a href="#开发调试" aria-hidden="true" class="header-anchor">#</a> 开发调试</h2> <p>关于<code>service-worker</code>的开发调试，在浏览器端主要在<code>Application</code> 中的 <code>Service Workers</code>中，</p> <p><img src="/img/service-worker1.jpg" alt="注册service worker"></p> <p>具体的调试方法可以<a href="https://lavas.baidu.com/pwa/offline-and-cache-loading/service-worker/service-worker-debug" target="_blank" rel="noopener noreferrer">查看这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="实例"><a href="#实例" aria-hidden="true" class="header-anchor">#</a> 实例</h2> <p>上边的练习可以查看源代码<a href>GitHub 仓库</a>自己来测试, 也可使用手机扫描下面二维码，打开页面后，你在关闭手机的所有网络，刷新浏览器你会发现，页面依然可以访问（因为页面已经被缓存起来了）（建议用高版本的Chorme 测试）</p> <p><img src="https://webxiaoma.github.io/JavaScript-demos/web-api/service-worker/img/1540978100.png" alt="二维码"></p> <hr> <p><strong>参考文章</strong></p> <ul><li><a href="https://lavas.baidu.com/pwa/offline-and-cache-loading/service-worker/service-worker-introduction" target="_blank" rel="noopener noreferrer">Service Worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://lavas.baidu.com/guide/vue/doc/vue/advanced/service-worker-postMessage#%E6%89%A9%E5%B1%95" target="_blank" rel="noopener noreferrer">Service Worker 与页面通信<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener noreferrer">MDN Service Worker API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/webxiaoma/webxiaoma/edit/dev/docs/javascript/service-worker.md" target="_blank" rel="noopener noreferrer">文章有问题，欢迎提出！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最近更新时间: </span> <span class="time">10/31/2018, 6:07:08 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/javascript/web-worker.html" class="prev">
          多线程 Web Worker
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/assets/js/30.291321ea.js" defer></script><script src="/assets/js/app.295b5d07.js" defer></script>
  </body>
</html>
